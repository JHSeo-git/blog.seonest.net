---
title: 'ë‚ ë ¸ìŠµë‹ˆë‹¤...'
description: 'mysql ë°±ì—… ë°©ë²•ê³¼ ORM ì‚¬ìš©ì‹œ ì£¼ì˜ì‚¬í•­ì— ëŒ€í•´ì„œ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤.'
date: '2021-07-16T08:18:22.931Z'
category: 'javascript'
draft: false
tags: ['JavaScript', 'TypeORM', 'MySQL']
thumbnail: '/post/javascript/ë‚ ë ¸ìŠµë‹ˆë‹¤/thumbnail.png'
---

ë°ì´í„° ë‚ ë ¸ìŠµë‹ˆë‹¤.

ëª‡ ê°œ ê¸€ì´ ì—†ê¸´ í–ˆì§€ë§Œ ê·¸ë˜ë„... ğŸ˜‡

ë¯¸ì²œí•œ ì œê°€ ì´ë ‡ê²Œ í•˜ë‚˜ ë°°ì›Œê°‘ë‹ˆë‹¤.

# ë°œìƒ

ì‹ ë‚˜ê²Œ ìƒˆë¡œìš´ í¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±ì„ ë‹¤ í•  ë•Œì¯¤ ì„ì‹œì €ì¥ ì‹œ 500 ì—ëŸ¬ê°€ ë‚¬ì—ˆìŠµë‹ˆë‹¤.

ë¬¸ì œê°€ ë¬´ì—‡ì¸ì§€ ì°¾ê¸° ìœ„í•´ì„œ ë¡œê·¸ë¥¼ ë³´ë‹ˆ utf8mb4 íƒ€ì…ì„ ì§€ì •í•´ì£¼ì§€ ì•Šì•„ ë°œìƒí•œ ê±°ì˜€ìŠµë‹ˆë‹¤.
(ë‚˜ì¤‘ì— í™•ì¸ëœ ê±´ ê¸€ ì‘ì„± ì‹œì— ì´ëª¨ì§€ë¥¼ ì‚¬ìš©í–ˆëŠ”ë° ê·¸ ë¶€ë¶„ì„ ì¸ì‹í•˜ì§€ ëª»í•œ ë¬¸ì œì˜€ìŠµë‹ˆë‹¤.)

ì²˜ìŒì—” ì»¬ëŸ¼ ê¸¸ì´ë³´ë‹¤ í…ìŠ¤íŠ¸ ê¸¸ì´ê°€ ê¸¸ì–´ì„œ ë¬¸ì œê°€ ìƒê²¼ëŠ”ì§€ ì‹¶ì–´ì„œ ì»¬ëŸ¼ íƒ€ì…ì„ textì—ì„œ longtextë¡œ ë³€ê²½ì‘ì—…ì„ í–ˆì—ˆìŠµë‹ˆë‹¤.(js entitiyë¥¼ í†µí•´)
ê°œë°œ ì‹œì—ëŠ” synchronizeë¥¼ í†µí•´ì„œ ìë™ìœ¼ë¡œ db ì—…ë°ì´íŠ¸ ë˜ë„ë¡ í•˜ì—¬ ì§„í–‰ì„ í•˜ê³  ìˆì—ˆê¸° ë•Œë¬¸ì— ë¬¸ì œëŠ” ì—†ì—ˆìŠµë‹ˆë‹¤.

ë¬¸ì œëŠ” ë‹¤ë¥¸ ê³³ì— ìˆì—ˆê³  500ì—ëŸ¬ëŠ” typeorm connect ì‹œ config ì„¤ì •ì— charsetì„ ì„¤ì •í•˜ëŠ” ë¶€ë¶„ì´ ìˆëŠ”ë° ê·¸ ê³³ì— utf8mb4ë¥¼ ë„£ì–´ì£¼ë‹ˆ ì˜¤ë¥˜ ì—†ì´ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.

ì •ìƒë™ì‘ì„ ìœ„í•´ backend ë°°í¬ë¥¼ ìœ„í•´ pushë¥¼ í•˜ê³  pm2 restartí•˜ëŠ” í–ˆìŠµë‹ˆë‹¤.(ì—¬ê¸°ì„œ ë‹¤ ë‚ ì•„ê°ìš”)

ê·¸ëŸ¬ê³  ê¸€ ì‘ì„±ì„ ë§ˆì¹˜ê³  postë¥¼ í•˜ì˜€ê³  ê¸€ ì˜ ì˜¬ë¼ê°”ëŠ”ì§€ í™•ì¸í•œ ë’¤ì— ì ì„ ìë ¤ê³ í–ˆëŠ”ë°...

ìê¸° ì „ì— ê¸°ì¡´ ê¸€ì„ í™•ì¸í•˜ê¸° ìœ„í•´ì„œ ëˆ„ë¥´ëŠ” ìˆœê°„ ... ë¹ˆ ë‚´ìš©ë§Œ ë‚˜ì˜¤ëŠ” í™”ë©´ì„ ë³´ê³  ì´ê±´ ë­”ê°€ ì˜ ëª» ë˜ì—ˆë‹¤ ë¼ê³  ì§ê°í–ˆì£ .

> ì•„(Ah)...
> synchronize

# ì›ì¸

ormìœ¼ë¡œ typeormì„ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.
dbëŠ” mariadbë¥¼ ì‚¬ìš©í•˜ê³  ìˆêµ¬ìš”.

ormì€ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ì‘ì„±ëœ entityë¥¼ dbì™€ ì—°ë™í•´ì¤˜ì„œ ì œê³µëœ í•¨ìˆ˜ë‚˜ í´ë˜ìŠ¤ë¥¼ í†µí•´ ì‰½ê²Œ db ì¿¼ë¦¬ ì‘ì—…ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ ì¤‘ synchronize(syncë¡œ ì¤„ì—¬ ë§í•˜ê² ìŠµë‹ˆë‹¤)ëŠ” ìë°”ìŠ¤í¬ë¦½í†  ì‘ì„±ëœ entityë¥¼ í†µí•´ schemaë¥¼ ìƒì„±, ìˆ˜ì •, ì‚­ì œ ë“±ì„ í•´ì£¼ëŠ” ì‘ì—…ì„ ë§í•©ë‹ˆë‹¤.

ë¬¸ì œëŠ” sync ì„¤ì •ì„ ë„ì§€ ì•Šê³  productionìœ¼ë¡œ ì§„í–‰í•˜ê³  ìˆì—ˆë‹¤ëŠ” ê²ƒì´ì—ˆìŠµë‹ˆë‹¤.

ê°œë°œ ì‹œì—ëŠ” í¸ì˜ì„±ì„ ìœ„í•´ syncì€ ì•„ì£¼ ì¢‹ì€ ì˜µì…˜ì…ë‹ˆë‹¤.
ì‹¤ì œ schemaë¥¼ ì‹ ê²½ì“°ì§€ ì•Šê³  ìë°”ìŠ¤í¬ë¦½íŠ¸ entityë§Œ ì‹ ê²½ì“°ë©´ ë˜ë‹ˆê¹Œ ê·¸ë ‡ìŠµë‹ˆë‹¤.

ê²°êµ­ì€ ìƒˆë¡­ê²Œ ì»¬ëŸ¼ íƒ€ì…ì´ ë³€ê²½ë˜ì–´ alter columnì´ ë˜ëŠ” ìˆœê°„ ê¸°ì¡´ columnì€ ì‚¬ë¼ì§€ê³  ìƒˆë¡œìš´ ì»¬ëŸ¼ íƒ€ì…ì„ ê°€ì§„ columnì´ ìƒì„±ë˜ì–´ í•´ë‹¹ ì»¬ëŸ¼ì— ìˆë˜ ë°ì´í„°ê°€ ì‹¹ ë‚ ì•„ê°€ëŠ” ì¼ì´ ë²Œì–´ì¡ŒìŠµë‹ˆë‹¤.

markdownì„ ì €ì¥í•˜ëŠ” ì»¬ëŸ¼ì´ ë³€ê²½ë˜ì—ˆê¸° ë•Œë¬¸ì— ë³¸ë¬¸ì„ ì €ì¥í•œ ë°ì´í„°ëŠ” ë‚ ì•„ê°”ì§€ë§Œ ê¸€ì€ ë‚¨ì•„ìˆì—ˆê³  ë¦¬ìŠ¤íŠ¸ëŠ” ë³´ì´ì§€ë§Œ ì‹¤ì œ ë‚´ìš©ì€ ë³´ì´ì§€ ì•ŠëŠ” ìƒíƒœë¡œ ë˜ì—ˆë˜ ê²ƒì´ì—ˆìŠµë‹ˆë‹¤.

# í•´ê²°ë°©ì‹(sad ending)

êµ¬ê¸€ë§ì„ í†µí•´ mysql, mariadb ë³µêµ¬ ê¸€ì„ ëª‡ê°œ ì°¾ë‹¤ ë³´ë‹ˆ flashbackì´ë¼ëŠ”ê²Œ ë³´ì˜€ìŠµë‹ˆë‹¤.

mariadb 10.2.x ë²„ì „ ë¶€í„° ì œê³µë˜ëŠ” ê¸°ëŠ¥ìœ¼ë¡œ binlogë¥¼ í†µí•´ì„œ ìŠ¤í‚¤ë§ˆ, ë°ì´í„° ë“±ì„ ë³µêµ¬í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

> ì•„!
> binlogë¥¼ ì°¾ì•„ë´ì•¼ì§€!
> ì‰? ì—†ë„¤?

ë¬¸ì œëŠ” db ì„¤ì •ì„ ì˜ í•´ë†¨ì–´ì•¼ binlogê°€ ì €ì¥ëœë‹¤ëŠ” ê²ƒì´ì—ˆìŠµë‹ˆë‹¤.

```
// (custom).cnf

[mysqld]
# Log Config
binlog_format                   = 2
expire_logs_days                = 10
long_query_time                 = 10
max_binlog_size                 = 512M
sync_binlog                     = 1
log-bin                         = mysql-bin
log-error                       = mysql.err
datadir                         = /var/lib/mysql/log
```

ìœ„ì™€ ê°™ì´ binlogë¥¼ ìœ„í•œ log config ì„¤ì •ì„ í•´ì£¼ê³  dbë¥¼ ì‹¤í–‰í•´ì•¼ binlogê°€ ìƒì„±ë©ë‹ˆë‹¤.

ì €ëŠ” ì•„~ì£¼ plain configë§Œ ì„¤ì •í•˜ì˜€ê¸° ë•Œë¬¸ì— ìˆì„ë¦¬ê°€ ì—†ì—ˆì£ .

> ìš°ì„  bin logê°€ ì¡´ì¬ë¥¼ í•´ì•¼ ê°€ëŠ¥í•˜ë‹¤. bin logì¡°ì°¨ ì—†ë‹¤ë©´ ê¹”ë”í•˜ê²Œ í¬ê¸°~~!!
> _- [ì–´ëŠ ë¸”ë¡œê·¸](http://gnujava.com/board/article_view.jsp?article_no=1860&menu_cd=29&board_no=16&table_cd=EPAR06&table_no=06)_

binlogë¥¼ í†µí•´ ë°±ì—…í•˜ëŠ” ë°©ë²•ì€ mysqlbinlogë¥¼ í†µí•´ sqlì„ ìƒì„±í•´ì„œ ë™ì‘ì‹œí‚¤ë©´ ë˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

```
$ mysqlbinlog /var/log/mysql/mybin-log.000001 > restore.sql
```

ê·¸ë˜ì„œ ë­...ê¹”ë”í•˜ê²Œ í¬ê¸°í•˜ê³  ì¼ë‹¨ ë‚˜ì¤‘ì— ìƒí™©ì„ ëŒ€ë¹„í•´ì„œ binlog ì„¤ì •ê³¼ ë‹¤ë¥¸ config ì„¤ì •ë“¤ì„ ë§ˆì¹˜ê³  docker ì„¤ì •ë„ ëª‡ê°€ì§€ ë” í•˜ê³  ë°°í¬í–ˆìŠµë‹ˆë‹¤.

# typeorm migration

> synchronize ê¸°ëŠ¥ì€ ê°œë°œ ì‹œì—” í¸í•˜ì§€ë§Œ ìš´ì˜ ì‹œì—” ë§¤ìš° ì£¼ì˜ê¹Šì— ì“°ê±°ë‚˜ ì‚¬ìš©í•˜ì§€ ë§ì•„ì•¼ í•©ë‹ˆë‹¤. ì™œëƒí•˜ë©´ ì € ì²˜ëŸ¼ ë  ìˆ˜ ìˆìœ¼ë‹ˆê¹ìš” ^^..
>
> _[ë‚˜](#)_

ìŠ¤í‚¤ë§ˆë¥¼ ìˆ˜ì •í•  ì‹œì—ëŠ” ë°ì´í„° ë˜í•œ ìˆ˜ì •ë˜ê±°ë‚˜ ì‚­ì œ ë˜ì–´ë²„ë¦´ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ë§¤ìš° ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ í•´ì•¼í•©ë‹ˆë‹¤.

typeormì—ëŠ” migration ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.(clië¥¼ ì´ìš©í•©ë‹ˆë‹¤.)
(up, down ê¸°ëŠ¥ì„ ì œê³µí•´ì£¼ì–´ì„œ rollback í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.)

## 1. ormconfig ì„¤ì •

```js
  cli: {
      ...
      migrationsDir: join(__dirname, '/migrations'),
  },
```

cli migrationDir ê²½ë¡œë¥¼ ì§€ì •í•´ì£¼ê³  ë§ˆì´ê·¸ë ˆì´ì…˜ ì½”ë“œë¥¼ ìƒì„±í•´ì¤ë‹ˆë‹¤.

## 2. migration:create

```bash
typeorm migration:create -n [whateverYouWantName]
```

scriptë¡œ ë§Œë“¤ì–´ ì“°ë„ë¡ í•©ì‹œë‹¤

```json
"typeorm": "node --require ts-node/register ./node_modules/typeorm/cli.js --config ./src/ormconfig.ts",
"migration": "yarn typeorm migration:run",
"migration:create": "yarn typeorm migration:create -n",
"migration:revert": "yarn typeorm migration:revert"
```

> migration:generate ê¸°ëŠ¥ë„ ìˆì§€ë§Œ tableì„ drop í›„ createí•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— createë°©ì‹ìœ¼ë¡œ ì“°ë„ë¡ í•˜ì.
>
> _-[Migration generation drops and creates columns instead of altering resulting in data loss](https://github.com/typeorm/typeorm/issues/3357)_

ê·¸ í›„ migration ì½”ë“œë¥¼ ì‘ì„±í•˜ë©´ ë.

## 3. implement migration code

migration:createë¥¼ í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ìƒì„±ë©ë‹ˆë‹¤.

```js
import {MigrationInterface, QueryRunner} from "typeorm";

export class UserTableCreate1615828367540 implements MigrationInterface {

    // migration do
    public async up(queryRunner: QueryRunner): Promise<void> {
    }

    // migration rollback
    public async down(queryRunner: QueryRunner): Promise<void> {
    }

}

```

ë‚´ë¶€ì— ì‹¤ì œ ë™ì‘í•  DDLì„ ì‘ì„±í•´ì¤ë‹ˆë‹¤.

```js
import { MigrationInterface, QueryRunner } from 'typeorm';

export class NewMigrationTIMESTAMP implements MigrationInterface {
  async up(queryRunner: QueryRunner): Promise<void> {
    await queryRunner.query(`ALTER TABLE "post" ALTER COLUMN "title" RENAME TO "name"`);
  }

  async down(queryRunner: QueryRunner): Promise<void> {
    await queryRunner.query(`ALTER TABLE "post" ALTER COLUMN "name" RENAME TO "title"`);
  }
}
```

## 4. run, revert

```bash
# up ë©”ì„œë“œê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.
typeorm migration:run

# down ë©”ì„œë“œê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.
typeorm migration:revert
```

# ë§ˆì¹˜ë©°

ê°œì¸ì ìœ¼ë¡œ ìš´ì˜í•˜ëŠ” dbë¼ì„œ ë§ì •ì´ì§€ ì‹¤ì œë¡œ ì„œë¹„ìŠ¤ë˜ëŠ” dbì— ì´ëŸ° ë¬¸ì œê°€ ìƒê²¼ìœ¼ë©´...

ê·¸ë˜ë„ ì´ë ‡ê²Œ ë˜ í•˜ë‚˜ ë°°ì›Œ ê°„ë‹¤ê³  ìƒê°í•˜ê³  ê¸ì •ì ìœ¼ë¡œ ìƒê°í•´ë³´ë ¤ê³  í•©ë‹ˆë‹¤.
~~(ê·¸ê²Œ ì˜ ì•ˆë¼...)~~

# reference

> - https://darrengwon.tistory.com/1311
> - https://github.com/typeorm/typeorm/blob/master/docs/faq.md
